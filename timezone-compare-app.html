<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>World Timeboard</title>
<style>
  :root{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --line:#e3e7ef;
    --text:#1f2633;
    --muted:#6b7280;
    --accent:#2563eb;
    --night:#e6e7ea;          /* 10pmâ€“5am */
    --day:#edf5ff;            /* 6amâ€“10pm */
    --work:#fff8d8;           /* 8amâ€“5pm */
    --hover:#e6ffe9;          /* column hover */
  }
  html,body{height:100%;}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
  }
  .app{max-width:1200px;margin:24px auto;padding:16px;background:var(--panel);border-radius:14px;box-shadow:0 8px 24px rgba(15,23,42,.08)}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .left, .right{display:flex;gap:12px;align-items:center}
  .searchbox{position:relative}
  .searchbox input{
    width:420px;max-width:70vw;padding:10px 12px 10px 36px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none;font-size:14px;
  }
  .searchbox svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.5}
  .pill{border:1px dashed var(--line);padding:8px 10px;border-radius:10px;font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--line);padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{border-color:transparent;background:var(--accent);color:#fff}
  .btn:active{transform:translateY(1px)}
  .dropdown{position:absolute;z-index:10;top:42px;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);max-height:280px;overflow:auto;display:none}
  .dropdown.show{display:block}
  .dropdown div{padding:10px 12px;cursor:pointer;font-size:14px}
  .dropdown div:hover{background:#f3f6ff}

  .grid{width:100%;border-collapse:separate;border-spacing:0 10px}
  .row-head{display:flex;align-items:center;gap:10px;width:280px;min-width:280px}
  .row{display:flex;align-items:stretch}
  .row + .row{margin-top:6px}
  .col-city{display:flex;align-items:center;gap:10px;padding:10px 8px}
  .offset-badge{min-width:38px;text-align:center;font-weight:600;color:var(--muted);cursor:pointer}
  .offset-badge.home{color:var(--accent)}
  .city{font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  .x{margin-left:auto;cursor:pointer;color:#a1a1aa}
  .x:hover{color:#ef4444}
  .cells{display:grid;grid-template-columns:repeat(24, 44px);border-left:1px solid var(--line)}
  .cell{position:relative;border-right:1px solid var(--line);text-align:center;padding:6px 0 4px 0;font-size:13px}
  .ampm{display:block;font-size:11px;color:var(--muted)}
  .datebox{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-weight:700}
  .datebox .mon{font-size:11px;color:#667085;line-height:12px}
  .datebox .day{font-size:14px}
  .night{background:var(--night)}
  .day{background:var(--day)}
  .work{background:var(--work)}
  .hovercol{position:absolute;top:0;bottom:0;background:var(--hover);pointer-events:none}
  .hourlabel{font-weight:700}

  .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
  .legend .swatch{width:14px;height:14px;border:1px solid var(--line);border-radius:3px}
  .swatch.night{background:var(--night)}
  .swatch.day{background:var(--day)}
  .swatch.work{background:var(--work)}
  .swatch.hover{background:var(--hover)}

  @media (max-width:900px){
    .row-head{min-width:220px;width:220px}
    .cells{grid-template-columns:repeat(24, 38px)}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="left">
      <div class="searchbox">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="search" type="text" placeholder="Place or timezone" autocomplete="off"/>
        <div id="dropdown" class="dropdown"></div>
      </div>
      <div class="legend">
        <span class="swatch night"></span> 10pmâ€“5am
        <span class="swatch day"></span> 6amâ€“10pm
        <span class="swatch work"></span> 8amâ€“5pm
        <span class="swatch hover"></span> hover compare
      </div>
    </div>
    <div class="right">
      <button id="share" class="btn">ðŸ”— Link to this view</button>
      <span id="shareurl" class="pill" title="Click the button to generate a shareable link"></span>
      <button id="reset" class="btn">Reset</button>
    </div>
  </div>

  <div id="board"></div>
</div>

<script>
// ------- Utilities -------
const pad = n => String(n).padStart(2,'0');
const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

// Get offset minutes for a timezone at a given Date (DST aware)
function tzOffsetMinutes(tz, date=new Date()){
  const dtf = new Intl.DateTimeFormat('en-US', {
    timeZone: tz,
    hour12: false,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second:'2-digit'
  });
  const parts = dtf.formatToParts(date);
  const map = {};
  for (const p of parts) map[p.type] = p.value;
  const tzTime = Date.UTC(map.year, map.month-1, map.day, map.hour, map.minute, map.second);
  return (tzTime - date.getTime()) / 60000; // minutes difference from UTC
}

function hoursAhead(baseTZ, otherTZ){
  const d = new Date();
  const diffMin = tzOffsetMinutes(otherTZ, d) - tzOffsetMinutes(baseTZ, d);
  return Math.round(diffMin/60); // spec asks for integer
}

function fmt12(h){
  const hour = (h % 12) || 12;
  const ampm = h < 12 ? 'am' : 'pm';
  return {hour, ampm};
}

// Generate a Date for the home-tz for column index (0..23) starting at startHour
function colDate(homeTZ, startHour, colIdx){
  // Use today per home TZ
  const now = new Date();
  const dtf = new Intl.DateTimeFormat('en-US', { timeZone: homeTZ, year:'numeric', month:'2-digit', day:'2-digit'});
  const parts = Object.fromEntries(dtf.formatToParts(now).map(p=>[p.type,p.value]));
  const y = Number(parts.year), m = Number(parts.month)-1, d = Number(parts.day);
  // hour sequence wraps 24 hrs from startHour
  const hour = (startHour + colIdx) % 24;
  const dayShift = Math.floor((startHour + colIdx)/24);
  const base = new Date(Date.UTC(y, m, d + dayShift, hour, 0, 0));
  // Convert from UTC date components to a timestamp representing the same wall clock time in homeTZ
  // We adjust by the homeTZ offset to get an absolute instant
  const offMin = tzOffsetMinutes(homeTZ, base);
  return new Date(base.getTime() - offMin*60000);
}

function atTZ(date, tz){
  // Return y,m,d,h for "date" viewed in timezone tz
  const dtf = new Intl.DateTimeFormat('en-US', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', hour12:false, hour:'2-digit'});
  const p = Object.fromEntries(dtf.formatToParts(date).map(x=>[x.type,x.value]));
  return { y:+p.year, m:+p.month, d:+p.day, h:+p.hour };
}

// ------- Data: timezones & city labels -------
const COMMON = [
  {label:'London, United Kingdom', tz:'Europe/London'},
  {label:'New York, USA', tz:'America/New_York'},
  {label:'Berlin, Germany', tz:'Europe/Berlin'},
  {label:'Johannesburg, South Africa', tz:'Africa/Johannesburg'},
  {label:'Stuttgart, Germany', tz:'Europe/Berlin'},
  {label:'Houston, USA', tz:'America/Chicago'},
  {label:'San Francisco, USA', tz:'America/Los_Angeles'},
  {label:'Chicago, USA', tz:'America/Chicago'},
  {label:'Singapore', tz:'Asia/Singapore'},
  {label:'Tokyo, Japan', tz:'Asia/Tokyo'},
  {label:'Sydney, Australia', tz:'Australia/Sydney'},
  {label:'Paris, France', tz:'Europe/Paris'},
  {label:'Madrid, Spain', tz:'Europe/Madrid'},
  {label:'Rome, Italy', tz:'Europe/Rome'},
  {label:'Dublin, Ireland', tz:'Europe/Dublin'},
  {label:'Toronto, Canada', tz:'America/Toronto'},
  {label:'Sao Paulo, Brazil', tz:'America/Sao_Paulo'},
  {label:'Mexico City, Mexico', tz:'America/Mexico_City'},
  {label:'Dubai, UAE', tz:'Asia/Dubai'},
  {label:'Mumbai, India', tz:'Asia/Kolkata'},
  {label:'Hong Kong', tz:'Asia/Hong_Kong'},
  {label:'Seoul, South Korea', tz:'Asia/Seoul'},
  {label:'Beijing, China', tz:'Asia/Shanghai'},
  {label:'Auckland, New Zealand', tz:'Pacific/Auckland'},
  {label:'Los Angeles, USA', tz:'America/Los_Angeles'},
  {label:'Zurich, Switzerland', tz:'Europe/Zurich'},
  {label:'Amsterdam, Netherlands', tz:'Europe/Amsterdam'},
  {label:'Stockholm, Sweden', tz:'Europe/Stockholm'},
  {label:'Vienna, Austria', tz:'Europe/Vienna'},
  {label:'Cape Town, South Africa', tz:'Africa/Johannesburg'},
  {label:'Warsaw, Poland', tz:'Europe/Warsaw'},
  {label:'Prague, Czechia', tz:'Europe/Prague'}
];
// Also allow raw IANA search when browser supports listing
let ALL_TZ = [];
try { if (Intl.supportedValuesOf) ALL_TZ = Intl.supportedValuesOf('timeZone'); } catch(e){}
const EXTRA = ALL_TZ.map(tz=>({label: tz, tz}));
const DIRECTORY = [...COMMON, ...EXTRA];

// ------- State -------
const STORAGE_KEY = 'world-timeboard-state-v1';

function defaultState(){
  return {
    startHour: 1, // home row starts 1am
    rows: [
      {label:'London, United Kingdom', tz:'Europe/London', home:true},
      {label:'New York, USA', tz:'America/New_York'},
      {label:'Berlin, Germany', tz:'Europe/Berlin'},
      {label:'Johannesburg, South Africa', tz:'Africa/Johannesburg'}
    ]
  };
}

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState();
    const parsed = JSON.parse(raw);
    if (!parsed || !Array.isArray(parsed.rows)) return defaultState();

    parsed.rows = parsed.rows
      .map(r => ({ label: r.label, tz: r.tz, home: !!r.home }))
      .filter(r => r.label && r.tz);

    if (!parsed.rows.length) return defaultState();
    if (!parsed.rows.some(r => r.home)) parsed.rows[0].home = true;

    parsed.startHour = typeof parsed.startHour === 'number'
      ? ((parsed.startHour % 24) + 24) % 24
      : 1;

    return parsed;
  } catch (e) {
    return defaultState();
  }
}

let state = loadState();

function saveState(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    // ignore storage errors (private mode, etc.)
  }
}

// Load from URL if present (shared links override stored state)
(function initFromURL(){
  const params = new URLSearchParams(location.search);
  const packed = params.get('zones');
  const home = params.get('home');
  const start = params.get('start');
  if (packed){
    const parts = packed.split(',').map(s=>decodeURIComponent(s));
    state.rows = parts.map(p=>{
      const [label, tz] = p.includes('|')? p.split('|') : [p, p];
      return {label, tz, home:false};
    });
    const idx = state.rows.findIndex(r=>r.tz===home);
    if (idx>=0) state.rows[idx].home = true; else if (state.rows.length) state.rows[0].home=true;
  }
  if (start) state.startHour = Math.max(0, Math.min(23, parseInt(start,10)||1));
})();

function setHome(index){
  state.rows.forEach((r,i)=>r.home = i===index);
  render();
}
function removeRow(index){ state.rows.splice(index,1); if (!state.rows.some(r=>r.home) && state.rows[0]) state.rows[0].home=true; render(); }

// ------- Rendering -------
const board = document.getElementById('board');
let hoverIdx = -1; // column hovered

function render(){
  const home = state.rows.find(r=>r.home) || state.rows[0];
  if (!home) { board.innerHTML = '<div class="pill">No places yet. Add one above.</div>'; return; }

  // Pre-compute the 24 column instants (absolute dates) relative to home tz & startHour
  const instants = Array.from({length:24}, (_,i)=> colDate(home.tz, state.startHour, i));

  board.innerHTML = '';
  state.rows.forEach((row, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'row';

    // Head section
    const head = document.createElement('div');
    head.className = 'row-head col-city';
    const off = hoursAhead(home.tz, row.tz);

    const offEl = document.createElement('div');
    offEl.className = 'offset-badge' + (row.home? ' home':'');
    offEl.title = row.home? 'Home timezone' : 'Click to make home timezone';
    offEl.innerHTML = row.home ? 'ðŸ ' : (off>0? '+'+off: off);
    offEl.addEventListener('click', ()=> setHome(idx));

    const city = document.createElement('div');
    city.className = 'city';
    city.textContent = row.label.split('|')[0] || row.label;

    const tzSpan = document.createElement('div');
    tzSpan.className = 'meta';
    tzSpan.textContent = row.tz;

    const close = document.createElement('div');
    close.className = 'x';
    close.textContent = 'âœ•';
    close.title = 'Remove row';
    close.addEventListener('click', ()=> removeRow(idx));

    head.append(offEl, city, tzSpan, close);

    // Cells section
    const cells = document.createElement('div');
    cells.className = 'cells';

    instants.forEach((instant, col)=>{
      const loc = atTZ(instant, row.tz);
      const c = document.createElement('div');
      c.className = 'cell';
      c.dataset.col = col;

      // Background bands
      const hour = loc.h;
      const inNight = (hour>=22 || hour<=5);
      const inWork = (hour>=8 && hour<=17);
      const inDay = !inNight; // 6..21
      if (inDay) c.classList.add('day');
      if (inNight) c.classList.add('night');
      if (inWork) c.classList.add('work');

      // Content
      if (hour===0){
        const db = document.createElement('div');
        db.className = 'datebox';
        db.innerHTML = `<div class="mon">${MONTHS[loc.m-1]}</div><div class="day">${loc.d}</div>`;
        c.appendChild(db);
      } else {
        const {hour:hh, ampm} = fmt12(hour);
        c.innerHTML = `<span class="hourlabel">${hh}</span><span class="ampm">${ampm}</span>`;
      }

      // Hover behavior: highlight same column everywhere
      c.addEventListener('mouseenter', ()=> highlightColumn(col));
      c.addEventListener('mouseleave', ()=> highlightColumn(-1));

      cells.appendChild(c);
    });

    wrap.append(head, cells);
    board.appendChild(wrap);
  });

  drawHover();
}

function highlightColumn(i){ hoverIdx = i; drawHover(); }

function drawHover(){
  // Clear previous overlays
  document.querySelectorAll('.hovercol').forEach(e=>e.remove());
  if (hoverIdx<0) return;
  document.querySelectorAll('.cells').forEach(cells=>{
    const col = document.createElement('div');
    col.className = 'hovercol';
    col.style.left = (hoverIdx* (cells.clientWidth/24)) + 'px';
    col.style.width = (cells.clientWidth/24) + 'px';
    cells.style.position='relative';
    cells.appendChild(col);
  });
}

// ------- Search -------
const search = document.getElementById('search');
const dropdown = document.getElementById('dropdown');
let ddIdx = -1; // highlighted suggestion

function openDropdown(items){
  dropdown.innerHTML = '';
  items.slice(0,60).forEach((item, i)=>{
    const d = document.createElement('div');
    d.textContent = `${item.label}  â€”  ${item.tz}`;
    d.addEventListener('click', ()=> { addRow(item); closeDropdown(); });
    dropdown.appendChild(d);
  });
  dropdown.classList.add('show');
}
function closeDropdown(){ dropdown.classList.remove('show'); ddIdx=-1; }

function addRow(item){
  state.rows.push({label:item.label, tz:item.tz});
  render();
  search.value='';
}

search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  if (!q){ closeDropdown(); return; }
  const results = DIRECTORY.filter(x=> x.label.toLowerCase().includes(q) || x.tz.toLowerCase().includes(q));
  if (results.length){ openDropdown(results); } else { closeDropdown(); }
});
search.addEventListener('keydown', (e)=>{
  if (!dropdown.classList.contains('show')) return;
  const items = Array.from(dropdown.children);
  if (e.key==='ArrowDown'){ ddIdx = Math.min(items.length-1, ddIdx+1); items.forEach((el,i)=> el.style.background = i===ddIdx?'#eef3ff':'' ); e.preventDefault(); }
  if (e.key==='ArrowUp'){ ddIdx = Math.max(0, ddIdx-1); items.forEach((el,i)=> el.style.background = i===ddIdx?'#eef3ff':'' ); e.preventDefault(); }
  if (e.key==='Enter' && ddIdx>=0){ items[ddIdx].click(); }
  if (e.key==='Escape'){ closeDropdown(); }
});

// Close dropdown if clicking elsewhere
window.addEventListener('click', (e)=>{ if (!document.querySelector('.searchbox').contains(e.target)) closeDropdown(); });

// ------- Shareable Link -------
function buildShareURL(){
  const zones = state.rows.map(r=> encodeURIComponent(`${r.label}|${r.tz}`)).join(',');
  const home = encodeURIComponent((state.rows.find(r=>r.home)||state.rows[0]).tz);
  const start = state.startHour;
  const url = `${location.origin}${location.pathname}?zones=${zones}&home=${home}&start=${start}`;
  return url;
}

const shareBtn = document.getElementById('share');
const shareOut = document.getElementById('shareurl');
shareBtn.addEventListener('click', ()=>{
  const url = buildShareURL();
  shareOut.textContent = url;
  shareOut.title = 'Share this URL';
  navigator.clipboard && navigator.clipboard.writeText(url).catch(()=>{});
});

// Reset
document.getElementById('reset').addEventListener('click', ()=>{
  history.replaceState({}, '', location.pathname);
  state = { startHour:1, rows:[
    {label:'London, United Kingdom', tz:'Europe/London', home:true},
    {label:'New York, USA', tz:'America/New_York'},
    {label:'Berlin, Germany', tz:'Europe/Berlin'},
    {label:'Johannesburg, South Africa', tz:'Africa/Johannesburg'}
  ]};
  render();
});

// initial render
render();

// Keep hover overlays positioned on resize
window.addEventListener('resize', drawHover);
</script>
</body>
</html>
