<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Days Between</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .cards-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .date-card {
            flex: 1;
            min-width: 300px;
        }

        .date-card h2 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            color: #667eea;
            font-weight: 600;
            font-size: 0.95em;
        }

        .date-card input[type="date"] {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .date-card input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-card select {
            width: 100%;
            padding: 10px;
            font-size: 0.95em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .date-card select:focus {
            outline: none;
            border-color: #667eea;
        }

        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .selector-group label {
            color: #667eea;
            font-weight: 600;
            font-size: 0.95em;
        }

        .day-of-week {
            margin-top: 8px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            min-width: 280px;
            flex-shrink: 0;
            max-height: fit-content;
        }

        .result-card .label {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .editable-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: inline-block;
            min-width: 100px;
        }

        .editable-number:hover {
            background: rgba(255,255,255,0.1);
        }

        .editable-number input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            width: 100%;
            font-family: inherit;
        }

        .editable-number input:focus {
            outline: none;
        }

        .working-days {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .working-days .number {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .working-days .number:hover {
            background: rgba(255,255,255,0.1);
        }

        .working-days .number input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            width: 80px;
            font-family: inherit;
        }

        .working-days .number input:focus {
            outline: none;
        }

        .working-days .sublabel {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .holidays-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.3);
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .holidays-list h3 {
            font-size: 1em;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .holiday-item {
            background: rgba(255,255,255,0.15);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .holiday-date {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .holiday-name {
            opacity: 0.95;
        }

        .loading {
            opacity: 0.7;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .cards-container {
                flex-direction: column;
            }

            .date-card, .result-card {
                width: 100%;
                min-width: auto;
            }

            .date-inputs {
                gap: 15px;
            }
        }

        .attribution {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 30px;
            font-size: 0.9em;
        }

        .attribution a {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .attribution a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Days Between</h1>
        
        <div class="cards-container">
            <div class="card date-card">
                <h2>Date Selection</h2>
                
                <div class="selector-group">
                    <label for="countrySelect">Country:</label>
                    <select id="countrySelect">
                        <option value="">Loading countries...</option>
                    </select>
                </div>

                <div class="selector-group" id="subdivisionSelector" style="display: none;">
                    <label for="subdivisionSelect">Subdivision:</label>
                    <select id="subdivisionSelect">
                        <option value="">All regions</option>
                    </select>
                </div>

                <div class="date-inputs">
                    <div class="date-input-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate">
                        <div class="day-of-week" id="startDayOfWeek"></div>
                    </div>

                    <div class="date-input-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate">
                        <div class="day-of-week" id="endDayOfWeek"></div>
                    </div>
                </div>
            </div>

            <div class="card result-card">
                <div class="label">Days Between</div>
                <div class="editable-number" id="daysBetween" onclick="makeEditable('daysBetween', 'total')" title="Click to edit">0</div>
                
                <div class="working-days">
                    <div class="number" id="workingDays" onclick="makeEditable('workingDays', 'working')" title="Click to edit">0</div>
                    <div class="sublabel">Working Days</div>
                </div>

                <div class="holidays-list" id="holidaysList"></div>
            </div>
        </div>

        <div class="attribution">
            Makes use of the public holiday API at <a href="https://date.nager.at" target="_blank">date.nager.at</a>
        </div>
    </div>

    <script>
        // Global variables
        let publicHolidays = [];
        let isEditingDays = false;
        let selectedSubdivision = null;
        let currentCountryCode = null;

        // Get today's date in YYYY-MM-DD format
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get next Christmas date
        function getNextChristmas() {
            const today = new Date();
            const currentYear = today.getFullYear();
            let christmas = new Date(currentYear, 11, 25, 0, 0, 0);

            if (today > christmas) {
                christmas = new Date(currentYear + 1, 11, 25, 0, 0, 0);
            }

            const year = christmas.getFullYear();
            const month = String(christmas.getMonth() + 1).padStart(2, '0');
            const day = String(christmas.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get day of week name
        function getDayOfWeek(dateString) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(dateString + 'T00:00:00');
            return days[date.getDay()];
        }

        // Calculate days between two dates
        function calculateDaysBetween(date1, date2) {
            const d1 = new Date(date1 + 'T00:00:00');
            const d2 = new Date(date2 + 'T00:00:00');
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Calculate working days (Monday-Friday, excluding public holidays)
        function calculateWorkingDays(date1, date2) {
            const d1 = new Date(date1 + 'T00:00:00');
            const d2 = new Date(date2 + 'T00:00:00');
            
            const startDate = d1 < d2 ? new Date(d1) : new Date(d2);
            const endDate = d1 < d2 ? new Date(d2) : new Date(d1);
            
            let workingDays = 0;
            const currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                // Check if it's a weekday and not a public holiday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    const isHoliday = publicHolidays.some(h => {
                        if (h.date !== dateStr) return false;
                        
                        // Check subdivision filter
                        if (selectedSubdivision) {
                            return h.counties === null || (h.counties && h.counties.includes(selectedSubdivision));
                        }
                        
                        return true;
                    });
                    
                    if (!isHoliday) {
                        workingDays++;
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return workingDays;
        }

        // Add days to a date
        function addDays(dateString, days) {
            const date = new Date(dateString + 'T00:00:00');
            date.setDate(date.getDate() + days);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Add working days to a date
        function addWorkingDays(dateString, workingDays) {
            let date = new Date(dateString + 'T00:00:00');
            let addedDays = 0;

            while (addedDays < workingDays) {
                date.setDate(date.getDate() + 1);
                const dayOfWeek = date.getDay();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    const isHoliday = publicHolidays.some(h => {
                        if (h.date !== dateStr) return false;
                        
                        // Check subdivision filter
                        if (selectedSubdivision) {
                            return h.counties === null || (h.counties && h.counties.includes(selectedSubdivision));
                        }
                        
                        return true;
                    });
                    
                    if (!isHoliday) {
                        addedDays++;
                    }
                }
            }

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get proper name for subdivision code
        function getSubdivisionName(code) {
            // Common subdivision mappings (ISO 3166-2 codes)
            const subdivisionMap = {
                // United Kingdom
                'GB-ENG': 'England',
                'GB-SCT': 'Scotland',
                'GB-WLS': 'Wales',
                'GB-NIR': 'Northern Ireland',
                
                // Germany
                'DE-BW': 'Baden-Württemberg',
                'DE-BY': 'Bavaria',
                'DE-BE': 'Berlin',
                'DE-BB': 'Brandenburg',
                'DE-HB': 'Bremen',
                'DE-HH': 'Hamburg',
                'DE-HE': 'Hesse',
                'DE-MV': 'Mecklenburg-Vorpommern',
                'DE-NI': 'Lower Saxony',
                'DE-NW': 'North Rhine-Westphalia',
                'DE-RP': 'Rhineland-Palatinate',
                'DE-SL': 'Saarland',
                'DE-SN': 'Saxony',
                'DE-ST': 'Saxony-Anhalt',
                'DE-SH': 'Schleswig-Holstein',
                'DE-TH': 'Thuringia',
                
                // Switzerland
                'CH-AG': 'Aargau',
                'CH-AI': 'Appenzell Innerrhoden',
                'CH-AR': 'Appenzell Ausserrhoden',
                'CH-BE': 'Bern',
                'CH-BL': 'Basel-Landschaft',
                'CH-BS': 'Basel-Stadt',
                'CH-FR': 'Fribourg',
                'CH-GE': 'Geneva',
                'CH-GL': 'Glarus',
                'CH-GR': 'Graubünden',
                'CH-JU': 'Jura',
                'CH-LU': 'Lucerne',
                'CH-NE': 'Neuchâtel',
                'CH-NW': 'Nidwalden',
                'CH-OW': 'Obwalden',
                'CH-SG': 'St. Gallen',
                'CH-SH': 'Schaffhausen',
                'CH-SO': 'Solothurn',
                'CH-SZ': 'Schwyz',
                'CH-TG': 'Thurgau',
                'CH-TI': 'Ticino',
                'CH-UR': 'Uri',
                'CH-VD': 'Vaud',
                'CH-VS': 'Valais',
                'CH-ZG': 'Zug',
                'CH-ZH': 'Zurich',
                
                // Austria
                'AT-1': 'Burgenland',
                'AT-2': 'Carinthia',
                'AT-3': 'Lower Austria',
                'AT-4': 'Upper Austria',
                'AT-5': 'Salzburg',
                'AT-6': 'Styria',
                'AT-7': 'Tyrol',
                'AT-8': 'Vorarlberg',
                'AT-9': 'Vienna',
                
                // Canada
                'CA-AB': 'Alberta',
                'CA-BC': 'British Columbia',
                'CA-MB': 'Manitoba',
                'CA-NB': 'New Brunswick',
                'CA-NL': 'Newfoundland and Labrador',
                'CA-NS': 'Nova Scotia',
                'CA-NT': 'Northwest Territories',
                'CA-NU': 'Nunavut',
                'CA-ON': 'Ontario',
                'CA-PE': 'Prince Edward Island',
                'CA-QC': 'Quebec',
                'CA-SK': 'Saskatchewan',
                'CA-YT': 'Yukon',
                
                // United States
                'US-AL': 'Alabama',
                'US-AK': 'Alaska',
                'US-AZ': 'Arizona',
                'US-AR': 'Arkansas',
                'US-CA': 'California',
                'US-CO': 'Colorado',
                'US-CT': 'Connecticut',
                'US-DE': 'Delaware',
                'US-FL': 'Florida',
                'US-GA': 'Georgia',
                'US-HI': 'Hawaii',
                'US-ID': 'Idaho',
                'US-IL': 'Illinois',
                'US-IN': 'Indiana',
                'US-IA': 'Iowa',
                'US-KS': 'Kansas',
                'US-KY': 'Kentucky',
                'US-LA': 'Louisiana',
                'US-ME': 'Maine',
                'US-MD': 'Maryland',
                'US-MA': 'Massachusetts',
                'US-MI': 'Michigan',
                'US-MN': 'Minnesota',
                'US-MS': 'Mississippi',
                'US-MO': 'Missouri',
                'US-MT': 'Montana',
                'US-NE': 'Nebraska',
                'US-NV': 'Nevada',
                'US-NH': 'New Hampshire',
                'US-NJ': 'New Jersey',
                'US-NM': 'New Mexico',
                'US-NY': 'New York',
                'US-NC': 'North Carolina',
                'US-ND': 'North Dakota',
                'US-OH': 'Ohio',
                'US-OK': 'Oklahoma',
                'US-OR': 'Oregon',
                'US-PA': 'Pennsylvania',
                'US-RI': 'Rhode Island',
                'US-SC': 'South Carolina',
                'US-SD': 'South Dakota',
                'US-TN': 'Tennessee',
                'US-TX': 'Texas',
                'US-UT': 'Utah',
                'US-VT': 'Vermont',
                'US-VA': 'Virginia',
                'US-WA': 'Washington',
                'US-WV': 'West Virginia',
                'US-WI': 'Wisconsin',
                'US-WY': 'Wyoming',
                'US-DC': 'District of Columbia',
                
                // Australia
                'AU-ACT': 'Australian Capital Territory',
                'AU-NSW': 'New South Wales',
                'AU-NT': 'Northern Territory',
                'AU-QLD': 'Queensland',
                'AU-SA': 'South Australia',
                'AU-TAS': 'Tasmania',
                'AU-VIC': 'Victoria',
                'AU-WA': 'Western Australia'
            };
            
            return subdivisionMap[code] || code;
        }

        // Fetch available countries
        async function fetchCountries() {
            try {
                const response = await fetch('https://date.nager.at/api/v3/AvailableCountries');
                const countries = await response.json();
                
                // Sort countries alphabetically by name
                countries.sort((a, b) => a.name.localeCompare(b.name));
                
                const select = document.getElementById('countrySelect');
                select.innerHTML = '<option value="">Select a country...</option>';
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.countryCode;
                    option.textContent = country.name;
                    select.appendChild(option);
                });

                // Set default to UK if available
                const ukOption = Array.from(select.options).find(opt => opt.value === 'GB');
                if (ukOption) {
                    select.value = 'GB';
                    await fetchPublicHolidays('GB');
                }
            } catch (error) {
                console.error('Error fetching countries:', error);
                document.getElementById('countrySelect').innerHTML = '<option value="">Error loading countries</option>';
            }
        }

        // Fetch public holidays for a country
        async function fetchPublicHolidays(countryCode, updateSubdivisionSelector = true) {
            if (!countryCode) {
                publicHolidays = [];
                selectedSubdivision = null;
                currentCountryCode = null;
                document.getElementById('subdivisionSelector').style.display = 'none';
                updateDisplay();
                return;
            }

            currentCountryCode = countryCode;

            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                const startYear = new Date(startDate).getFullYear();
                const endYear = new Date(endDate).getFullYear();
                
                // Fetch holidays for all years in range
                const years = [];
                for (let year = startYear; year <= endYear; year++) {
                    years.push(year);
                }

                const holidayPromises = years.map(year => 
                    fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/${countryCode}`)
                        .then(res => res.json())
                );

                const holidayArrays = await Promise.all(holidayPromises);
                publicHolidays = holidayArrays.flat();
                
                // Only update subdivision selector if requested (when country changes, not when refetching for new years)
                if (updateSubdivisionSelector) {
                    // Check if any holidays have counties/subdivisions
                    const subdivisions = new Set();
                    publicHolidays.forEach(holiday => {
                        if (holiday.counties && holiday.counties.length > 0) {
                            holiday.counties.forEach(county => subdivisions.add(county));
                        }
                    });

                    // Show subdivision selector if subdivisions exist
                    const subdivisionSelector = document.getElementById('subdivisionSelector');
                    const subdivisionSelect = document.getElementById('subdivisionSelect');
                    
                    if (subdivisions.size > 0) {
                        // Sort subdivisions alphabetically by display name
                        const sortedSubdivisions = Array.from(subdivisions).sort((a, b) => {
                            return getSubdivisionName(a).localeCompare(getSubdivisionName(b));
                        });
                        
                        // Create dropdown options with proper names
                        let html = '<option value="">All regions</option>';
                        sortedSubdivisions.forEach(subdivision => {
                            const displayName = getSubdivisionName(subdivision);
                            html += `<option value="${subdivision}">${displayName}</option>`;
                        });
                        
                        subdivisionSelect.innerHTML = html;
                        subdivisionSelector.style.display = 'block';
                        
                        // Reset selection
                        subdivisionSelect.value = '';
                        selectedSubdivision = null;
                    } else {
                        subdivisionSelector.style.display = 'none';
                        selectedSubdivision = null;
                    }
                }
                
                updateDisplay();
            } catch (error) {
                console.error('Error fetching public holidays:', error);
                publicHolidays = [];
                selectedSubdivision = null;
                currentCountryCode = null;
                document.getElementById('subdivisionSelector').style.display = 'none';
                updateDisplay();
            }
        }

        // Get holidays between two dates
        function getHolidaysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            
            const startDate = d1 < d2 ? date1 : date2;
            const endDate = d1 < d2 ? date2 : date1;

            return publicHolidays
                .filter(h => {
                    // Filter by date range
                    if (h.date < startDate || h.date > endDate) return false;
                    
                    // Filter by subdivision
                    if (selectedSubdivision) {
                        // Include if counties is null (global) or contains the selected subdivision
                        return h.counties === null || (h.counties && h.counties.includes(selectedSubdivision));
                    }
                    
                    return true;
                })
                .sort((a, b) => a.date.localeCompare(b.date));
        }

        // Update holidays list display
        function updateHolidaysList() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const holidaysList = document.getElementById('holidaysList');

            const holidays = getHolidaysBetween(startDate, endDate);

            if (holidays.length === 0) {
                holidaysList.innerHTML = '';
                return;
            }

            let html = `<h3>Public Holidays (${holidays.length})</h3>`;
            holidays.forEach(holiday => {
                const holidayDate = new Date(holiday.date + 'T00:00:00');
                html += `
                    <div class="holiday-item">
                        <div class="holiday-date">${holidayDate.toLocaleDateString('en-GB', { 
                            weekday: 'short', 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric' 
                        })}</div>
                        <div class="holiday-name">${holiday.name}</div>
                    </div>
                `;
            });

            holidaysList.innerHTML = html;
        }

        // Update day of week display
        function updateDayOfWeek() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate) {
                document.getElementById('startDayOfWeek').textContent = getDayOfWeek(startDate);
            }

            if (endDate) {
                document.getElementById('endDayOfWeek').textContent = getDayOfWeek(endDate);
            }
        }

        // Check if we need to refetch holidays based on date range
        async function checkAndRefetchHolidays() {
            if (!currentCountryCode) {
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                return;
            }

            const startYear = new Date(startDate).getFullYear();
            const endYear = new Date(endDate).getFullYear();
            
            // Get the years we currently have holidays for
            const currentYears = new Set();
            publicHolidays.forEach(holiday => {
                const year = new Date(holiday.date).getFullYear();
                currentYears.add(year);
            });
            
            // Check if we need any years that we don't have
            let needsRefetch = false;
            for (let year = startYear; year <= endYear; year++) {
                if (!currentYears.has(year)) {
                    needsRefetch = true;
                    break;
                }
            }
            
            if (needsRefetch) {
                // Don't update subdivision selector when refetching for additional years
                await fetchPublicHolidays(currentCountryCode, false);
            }
        }

        // Update the display
        async function updateDisplay() {
            if (isEditingDays) return;

            // Check if we need to refetch holidays for new years
            await checkAndRefetchHolidays();

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const days = calculateDaysBetween(startDate, endDate);
                const workingDays = calculateWorkingDays(startDate, endDate);

                document.getElementById('daysBetween').textContent = days;
                document.getElementById('workingDays').textContent = workingDays;

                updateDayOfWeek();
                updateHolidaysList();
            }
        }

        // Make a number editable
        function makeEditable(elementId, type) {
            if (isEditingDays) return;

            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent);

            isEditingDays = true;

            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.min = '0';

            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();

            const finishEdit = async () => {
                const newValue = parseInt(input.value) || 0;
                isEditingDays = false;

                if (newValue !== currentValue) {
                    await recalculateEndDate(newValue, type);
                } else {
                    element.textContent = currentValue;
                }
            };

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                }
            });
        }

        // Recalculate end date based on new day count
        async function recalculateEndDate(newDays, type) {
            const startDate = document.getElementById('startDate').value;
            let newEndDate;

            if (type === 'total') {
                newEndDate = addDays(startDate, newDays);
            } else if (type === 'working') {
                newEndDate = addWorkingDays(startDate, newDays);
            }

            document.getElementById('endDate').value = newEndDate;
            await updateDisplay();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Set default dates
            document.getElementById('startDate').value = getTodayString();
            document.getElementById('endDate').value = getNextChristmas();

            // Fetch countries and set up country selector
            await fetchCountries();

            // Add event listeners
            document.getElementById('startDate').addEventListener('change', updateDisplay);
            document.getElementById('endDate').addEventListener('change', updateDisplay);
            document.getElementById('countrySelect').addEventListener('change', (e) => {
                fetchPublicHolidays(e.target.value);
            });
            document.getElementById('subdivisionSelect').addEventListener('change', async (e) => {
                selectedSubdivision = e.target.value || null;
                await updateDisplay();
            });

            // Initial calculation
            await updateDisplay();
        });
    </script>
</body>
</html>
